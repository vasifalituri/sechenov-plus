generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                 @id @default(uuid())
  email                String                 @unique
  username             String?                @unique
  password             String
  fullName             String
  academicYear         Int
  profileImage         String?
  status               UserStatus             @default(PENDING)
  role                 UserRole               @default(USER)
  emailVerified        Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  announcements        Announcement[]         @relation("AnnouncementAuthor")
  bookmarks            Bookmark[]
  approvedComments     Comment[]              @relation("CommentApprover")
  comments             Comment[]              @relation("CommentAuthor")
  approvedThreads      DiscussionThread[]     @relation("ThreadApprover")
  discussionThreads    DiscussionThread[]     @relation("ThreadAuthor")
  externalResources    ExternalResource[]     @relation("ResourceCreator")
  downloads            MaterialDownload[]
  approvedMaterials    Material[]             @relation("MaterialApprover")
  uploadedMaterials    Material[]             @relation("MaterialUploader")
  receivedMessages     Message[]              @relation("MessageReceiver")
  sentMessages         Message[]              @relation("MessageSender")
  createdNotifications Notification[]         @relation("NotificationCreator")
  notifications        Notification[]         @relation("NotificationReceiver")
  pollVotes            PollVote[]             @relation("PollVoter")
  createdPolls         Poll[]                 @relation("PollCreator")
  quizAttempts         QuizAttempt[]
  ratings              Rating[]
  teacherRatings       TeacherRating[]        @relation("UserTeacherRatings")
  reviewHelpful        TeacherReviewHelpful[] @relation("UserReviewHelpful")
  teacherReviews       TeacherReview[]        @relation("UserTeacherReviews")
  verificationCodes    VerificationCode[]
  votes                Vote[]

  @@index([email])
  @@index([username])
  @@index([status])
  @@map("users")
}

model Subject {
  id                String             @id @default(uuid())
  name              String
  slug              String             @unique
  description       String?
  order             Int                @default(0)
  createdAt         DateTime           @default(now())
  discussionThreads DiscussionThread[]
  materials         Material[]
  quizAttempts      QuizAttempt[]
  quizBlocks        QuizBlock[]
  quizQuestions     QuizQuestion[]
  teachers          TeacherSubject[]

  @@index([slug])
  @@map("subjects")
}

model Material {
  id            String             @id @default(uuid())
  title         String
  description   String?
  subjectId     String
  academicYear  Int
  filePath      String
  fileName      String
  fileType      FileType
  fileSize      Int
  storageType   StorageType        @default(SUPABASE)
  storageBucket String?
  externalUrl   String?
  megaAccountId Int?
  tags          String[]
  status        ContentStatus      @default(PENDING)
  uploadedById  String
  approvedById  String?
  downloadCount Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  bookmarks     Bookmark[]
  downloads     MaterialDownload[]
  approvedBy    User?              @relation("MaterialApprover", fields: [approvedById], references: [id])
  subject       Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  uploadedBy    User               @relation("MaterialUploader", fields: [uploadedById], references: [id])
  ratings       Rating[]

  @@index([subjectId])
  @@index([academicYear])
  @@index([status])
  @@index([createdAt])
  @@map("materials")
}

model MaterialDownload {
  id           String   @id @default(uuid())
  materialId   String
  userId       String
  downloadedAt DateTime @default(now())
  material     Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([materialId, userId])
  @@index([materialId])
  @@index([userId])
  @@map("material_downloads")
}

model DiscussionThread {
  id            String        @id @default(uuid())
  title         String
  content       String
  subjectId     String
  academicYear  Int
  authorId      String
  status        ContentStatus @default(PENDING)
  approvedById  String?
  upvotes       Int           @default(0)
  downvotes     Int           @default(0)
  commentsCount Int           @default(0)
  isPinned      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  bookmarks     Bookmark[]
  comments      Comment[]
  approvedBy    User?         @relation("ThreadApprover", fields: [approvedById], references: [id])
  author        User          @relation("ThreadAuthor", fields: [authorId], references: [id])
  subject       Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  votes         Vote[]

  @@index([subjectId])
  @@index([academicYear])
  @@index([status])
  @@index([createdAt])
  @@index([upvotes])
  @@map("discussion_threads")
}

model Comment {
  id           String           @id @default(uuid())
  content      String
  threadId     String
  parentId     String?
  authorId     String
  status       ContentStatus    @default(PENDING)
  approvedById String?
  upvotes      Int              @default(0)
  downvotes    Int              @default(0)
  depth        Int              @default(0)
  isPinned     Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  approvedBy   User?            @relation("CommentApprover", fields: [approvedById], references: [id])
  author       User             @relation("CommentAuthor", fields: [authorId], references: [id])
  parent       Comment?         @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]        @relation("CommentReplies")
  thread       DiscussionThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  votes        Vote[]

  @@index([threadId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
  @@index([upvotes])
  @@map("comments")
}

model Vote {
  id        String            @id @default(uuid())
  userId    String
  threadId  String?
  commentId String?
  type      VoteType
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  comment   Comment?          @relation(fields: [commentId], references: [id], onDelete: Cascade)
  thread    DiscussionThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([threadId])
  @@index([commentId])
  @@map("votes")
}

model Message {
  id         String   @id @default(uuid())
  content    String
  senderId   String
  receiverId String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

model Bookmark {
  id           String            @id @default(uuid())
  userId       String
  type         BookmarkType
  materialId   String?
  discussionId String?
  note         String?
  createdAt    DateTime          @default(now())
  discussion   DiscussionThread? @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  material     Material?         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, materialId])
  @@unique([userId, discussionId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("bookmarks")
}

model Rating {
  id         String   @id @default(uuid())
  userId     String
  materialId String
  rating     Int
  review     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, materialId])
  @@index([materialId])
  @@index([rating])
  @@index([createdAt])
  @@map("ratings")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  link        String?
  isRead      Boolean          @default(false)
  createdById String?
  createdAt   DateTime         @default(now())
  createdBy   User?            @relation("NotificationCreator", fields: [createdById], references: [id])
  user        User             @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  email     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@map("verification_codes")
}

model Announcement {
  id        String           @id @default(cuid())
  title     String
  content   String
  type      AnnouncementType @default(INFO)
  priority  Int              @default(0)
  isActive  Boolean          @default(true)
  authorId  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  expiresAt DateTime?
  author    User             @relation("AnnouncementAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([priority])
  @@index([createdAt])
  @@index([authorId])
  @@map("announcements")
}

model ExternalResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  icon        String   @default("ðŸ”—")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation("ResourceCreator", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([order])
  @@index([authorId])
  @@map("external_resources")
}

model Poll {
  id          String       @id @default(cuid())
  question    String
  description String?
  isActive    Boolean      @default(true)
  isMultiple  Boolean      @default(false)
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  expiresAt   DateTime?
  options     PollOption[]
  votes       PollVote[]
  createdBy   User         @relation("PollCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([createdAt])
  @@index([createdById])
  @@map("polls")
}

model PollOption {
  id     String     @id @default(cuid())
  pollId String
  text   String
  order  Int        @default(0)
  poll   Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes  PollVote[]

  @@index([pollId])
  @@map("poll_options")
}

model PollVote {
  id        String     @id @default(cuid())
  pollId    String
  optionId  String
  userId    String
  createdAt DateTime   @default(now())
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User       @relation("PollVoter", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId, optionId])
  @@index([pollId])
  @@index([optionId])
  @@index([userId])
  @@map("poll_votes")
}

model Teacher {
  id             String           @id @default(cuid())
  fullName       String
  department     String
  position       String?
  photoUrl       String?
  bio            String?
  academicDegree String?
  isActive       Boolean          @default(true)
  averageRating  Float            @default(0)
  totalRatings   Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  ratings        TeacherRating[]
  reviews        TeacherReview[]
  subjects       TeacherSubject[]

  @@index([department])
  @@index([averageRating])
  @@index([isActive])
  @@map("teachers")
}

model TeacherSubject {
  id        String   @id @default(cuid())
  teacherId String
  subjectId String
  createdAt DateTime @default(now())
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

model TeacherRating {
  id                  String   @id @default(cuid())
  teacherId           String
  userId              String
  knowledgeRating     Int
  teachingRating      Int
  communicationRating Int
  fairnessRating      Int
  overallRating       Float
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  teacher             Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  user                User     @relation("UserTeacherRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teacherId, userId])
  @@index([teacherId])
  @@index([userId])
  @@index([overallRating])
  @@map("teacher_ratings")
}

model TeacherReview {
  id             String                 @id @default(cuid())
  teacherId      String
  userId         String
  content        String
  isAnonymous    Boolean                @default(false)
  status         ContentStatus          @default(PENDING)
  helpfulCount   Int                    @default(0)
  unhelpfulCount Int                    @default(0)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  helpfulness    TeacherReviewHelpful[]
  teacher        Teacher                @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  user           User                   @relation("UserTeacherReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("teacher_reviews")
}

model TeacherReviewHelpful {
  id        String        @id @default(cuid())
  reviewId  String
  userId    String
  isHelpful Boolean
  createdAt DateTime      @default(now())
  review    TeacherReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User          @relation("UserReviewHelpful", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("teacher_review_helpful")
}

model QuizBlock {
  id            String             @id @default(cuid())
  title         String
  description   String?
  subjectId     String
  questionCount Int                @default(0)
  difficulty    QuestionDifficulty @default(MEDIUM)
  isActive      Boolean            @default(true)
  orderIndex    Int                @default(0)
  totalAttempts Int                @default(0)
  averageScore  Float              @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  attempts      QuizAttempt[]
  subject       Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions     QuizQuestion[]

  @@index([subjectId])
  @@index([isActive])
  @@index([difficulty])
  @@index([orderIndex])
  @@map("quiz_blocks")
}

model QuizQuestion {
  id            String             @id @default(cuid())
  blockId       String?
  subjectId     String
  questionText  String
  questionImage String?
  explanation   String?
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  optionE       String?
  correctAnswer String
  questionType  QuestionType       @default(SINGLE)
  difficulty    QuestionDifficulty @default(MEDIUM)
  isActive      Boolean            @default(true)
  tags          String[]
  timesShown    Int                @default(0)
  timesCorrect  Int                @default(0)
  timesWrong    Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  answers       QuizAnswer[]
  block         QuizBlock?         @relation(fields: [blockId], references: [id])
  subject       Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([blockId])
  @@index([subjectId])
  @@index([isActive])
  @@index([difficulty])
  @@index([correctAnswer])
  @@map("quiz_questions")
}

model QuizAttempt {
  id             String       @id @default(cuid())
  userId         String
  mode           QuizMode
  blockId        String?
  subjectId      String?
  totalQuestions Int
  correctAnswers Int
  wrongAnswers   Int
  skippedAnswers Int          @default(0)
  score          Float
  startedAt      DateTime     @default(now())
  completedAt    DateTime?
  timeSpent      Int?
  isCompleted    Boolean      @default(false)
  answers        QuizAnswer[]
  block          QuizBlock?   @relation(fields: [blockId], references: [id])
  subject        Subject?     @relation(fields: [subjectId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mode])
  @@index([blockId])
  @@index([subjectId])
  @@index([isCompleted])
  @@index([startedAt])
  @@index([score])
  @@map("quiz_attempts")
}

model QuizAnswer {
  id            String       @id @default(cuid())
  attemptId     String
  questionId    String
  userAnswer    String?
  isCorrect     Boolean
  timeSpent     Int?
  questionOrder Int          @default(0)
  createdAt     DateTime     @default(now())
  attempt       QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question      QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([attemptId, questionOrder])
  @@map("quiz_answers")
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum ContentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FileType {
  PDF
  DOCX
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum BookmarkType {
  MATERIAL
  DISCUSSION
}

enum StorageType {
  SUPABASE
  EXTERNAL_MEGA
  LOCAL
}

enum QuizMode {
  RANDOM_30
  BLOCK
}

enum QuestionType {
  SINGLE
  MULTIPLE
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum NotificationType {
  MENTION
  REPLY
  NEW_MESSAGE
  MATERIAL_RATED
}

enum AnnouncementType {
  INFO
  WARNING
  SUCCESS
  ERROR
}
