// Prisma Schema for Medical Exam Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum ContentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FileType {
  PDF
  DOCX
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum BookmarkType {
  MATERIAL
  DISCUSSION
}

enum StorageType {
  SUPABASE // Files stored in Supabase Storage
  EXTERNAL_MEGA // Files stored in MEGA
  LOCAL // Legacy: files in local filesystem (for migration)
}

// Models
model User {
  id            String     @id @default(uuid())
  email         String     @unique
  username      String?    @unique
  password      String
  fullName      String
  academicYear  Int // 1-6
  profileImage  String? // Path to profile image
  status        UserStatus @default(PENDING)
  role          UserRole   @default(USER)
  emailVerified Boolean    @default(false) // Email verification status
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  uploadedMaterials    Material[]         @relation("MaterialUploader")
  approvedMaterials    Material[]         @relation("MaterialApprover")
  discussionThreads    DiscussionThread[] @relation("ThreadAuthor")
  approvedThreads      DiscussionThread[] @relation("ThreadApprover")
  comments             Comment[]          @relation("CommentAuthor")
  approvedComments     Comment[]          @relation("CommentApprover")
  votes                Vote[]
  sentMessages         Message[]          @relation("MessageSender")
  receivedMessages     Message[]          @relation("MessageReceiver")
  bookmarks            Bookmark[]
  ratings              Rating[]
  notifications        Notification[]     @relation("NotificationReceiver")
  createdNotifications Notification[]     @relation("NotificationCreator")
  downloads            MaterialDownload[]
  verificationCodes    VerificationCode[]
  announcements        Announcement[]     @relation("AnnouncementAuthor")
  externalResources    ExternalResource[] @relation("ResourceCreator")
  createdPolls         Poll[]             @relation("PollCreator")
  pollVotes            PollVote[]         @relation("PollVoter")
  teacherRatings       TeacherRating[]    @relation("UserTeacherRatings")
  teacherReviews       TeacherReview[]    @relation("UserTeacherReviews")
  reviewHelpful        TeacherReviewHelpful[] @relation("UserReviewHelpful")

  @@index([email])
  @@index([username])
  @@index([status])
  @@map("users")
}

model Subject {
  id          String   @id @default(uuid())
  name        String // e.g., "–ê–Ω–∞—Ç–æ–º–∏—è"
  slug        String   @unique // e.g., "anatomy"
  description String?
  order       Int      @default(0) // For sorting
  createdAt   DateTime @default(now())

  // Relations
  materials         Material[]
  discussionThreads DiscussionThread[]
  teachers          TeacherSubject[]

  @@index([slug])
  @@map("subjects")
}

model Material {
  id            String        @id @default(uuid())
  title         String
  description   String?
  subjectId     String
  academicYear  Int // 1-6
  filePath      String // Storage path (Supabase path or external identifier)
  fileName      String // Original filename
  fileType      FileType
  fileSize      Int // In bytes
  storageType   StorageType   @default(SUPABASE) // Where file is stored
  storageBucket String? // Supabase bucket name (e.g., "materials")
  externalUrl   String? // Direct URL for external storage (MEGA, etc.)
  megaAccountId Int? // Which MEGA account stores this file (1, 2, 3, etc.)
  tags          String[] // ["high-yield", "exam-relevant"]
  status        ContentStatus @default(PENDING)
  uploadedById  String
  approvedById  String?
  downloadCount Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  subject    Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  uploadedBy User               @relation("MaterialUploader", fields: [uploadedById], references: [id])
  approvedBy User?              @relation("MaterialApprover", fields: [approvedById], references: [id])
  bookmarks  Bookmark[]
  ratings    Rating[]
  downloads  MaterialDownload[]

  @@index([subjectId])
  @@index([academicYear])
  @@index([status])
  @@index([createdAt])
  @@map("materials")
}

// Track unique downloads per user
model MaterialDownload {
  id           String   @id @default(uuid())
  materialId   String
  userId       String
  downloadedAt DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([materialId, userId]) // One record per user per material
  @@index([materialId])
  @@index([userId])
  @@map("material_downloads")
}

model DiscussionThread {
  id            String        @id @default(uuid())
  title         String
  content       String        @db.Text
  subjectId     String
  academicYear  Int // 1-6
  authorId      String
  status        ContentStatus @default(PENDING)
  approvedById  String?
  upvotes       Int           @default(0)
  downvotes     Int           @default(0)
  commentsCount Int           @default(0)
  isPinned      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  subject    Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  author     User       @relation("ThreadAuthor", fields: [authorId], references: [id])
  approvedBy User?      @relation("ThreadApprover", fields: [approvedById], references: [id])
  comments   Comment[]
  votes      Vote[]
  bookmarks  Bookmark[]

  @@index([subjectId])
  @@index([academicYear])
  @@index([status])
  @@index([createdAt])
  @@index([upvotes])
  @@map("discussion_threads")
}

model Comment {
  id           String        @id @default(uuid())
  content      String        @db.Text
  threadId     String
  parentId     String? // For nested comments
  authorId     String
  status       ContentStatus @default(PENDING)
  approvedById String?
  upvotes      Int           @default(0)
  downvotes    Int           @default(0)
  depth        Int           @default(0) // 0 = top-level, 1 = reply, etc.
  isPinned     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  thread     DiscussionThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  parent     Comment?         @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[]        @relation("CommentReplies")
  author     User             @relation("CommentAuthor", fields: [authorId], references: [id])
  approvedBy User?            @relation("CommentApprover", fields: [approvedById], references: [id])
  votes      Vote[]

  @@index([threadId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
  @@index([upvotes])
  @@map("comments")
}

model Vote {
  id        String   @id @default(uuid())
  userId    String
  threadId  String?
  commentId String?
  type      VoteType // UPVOTE or DOWNVOTE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread  DiscussionThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  comment Comment?          @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([threadId])
  @@index([commentId])
  @@map("votes")
}

model Message {
  id         String   @id @default(uuid())
  content    String   @db.Text
  senderId   String
  receiverId String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

model Bookmark {
  id           String       @id @default(uuid())
  userId       String
  type         BookmarkType
  materialId   String?
  discussionId String?
  note         String?      @db.Text // Optional note for the bookmark
  createdAt    DateTime     @default(now())

  // Relations
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  material   Material?         @relation(fields: [materialId], references: [id], onDelete: Cascade)
  discussion DiscussionThread? @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@unique([userId, materialId])
  @@unique([userId, discussionId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("bookmarks")
}

model Rating {
  id         String   @id @default(uuid())
  userId     String
  materialId String
  rating     Int // 1-5 stars
  review     String?  @db.Text // Optional text review
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([userId, materialId]) // User can only rate a material once
  @@index([materialId])
  @@index([rating])
  @@index([createdAt])
  @@map("ratings")
}

enum NotificationType {
  MENTION // –£–ø–æ–º—è–Ω—É–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
  REPLY // –û—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  NEW_MESSAGE // –ù–æ–≤–æ–µ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  MATERIAL_RATED // –û—Ü–µ–Ω–∏–ª–∏ –≤–∞—à –º–∞—Ç–µ—Ä–∏–∞–ª
}

model Notification {
  id          String           @id @default(uuid())
  userId      String // –ö–æ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  type        NotificationType
  title       String
  message     String           @db.Text
  link        String? // –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  isRead      Boolean          @default(false)
  createdById String? // –ö—Ç–æ —Å–æ–∑–¥–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  createdAt   DateTime         @default(now())

  // Relations
  user      User  @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  createdBy User? @relation("NotificationCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Email verification codes
model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  email     String
  code      String // 6-digit code
  expiresAt DateTime // Code valid for 15 minutes
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@map("verification_codes")
}

// Announcements - Admin can post announcements on the homepage
model Announcement {
  id        String           @id @default(cuid())
  title     String           // Title of the announcement
  content   String           @db.Text // Full content (supports markdown)
  type      AnnouncementType @default(INFO) // Type: INFO, WARNING, SUCCESS, ERROR
  priority  Int              @default(0) // Higher number = shown first
  isActive  Boolean          @default(true) // Only active announcements are shown

  // Author
  authorId String
  author   User   @relation("AnnouncementAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Optional expiration date

  @@index([isActive])
  @@index([priority])
  @@index([createdAt])
  @@index([authorId])
  @@map("announcements")
}

enum AnnouncementType {
  INFO    // Blue - general information
  WARNING // Yellow - important notices
  SUCCESS // Green - positive news
  ERROR   // Red - critical alerts
}

// External Resources (e.g., Google Drive, Yandex Disk links)
model ExternalResource {
  id          String   @id @default(cuid())
  title       String   // Resource title (e.g., "–õ–µ–∫—Ü–∏–∏ –ø–æ –∞–Ω–∞—Ç–æ–º–∏–∏")
  description String?  @db.Text // Optional description
  url         String   // Link to external resource (Google Drive, Yandex Disk, etc.)
  icon        String   @default("üîó") // Emoji icon for display
  order       Int      @default(0) // Display order (lower = shown first)
  isActive    Boolean  @default(true) // Only active resources are shown

  // Author
  authorId String
  author   User   @relation("ResourceCreator", fields: [authorId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@index([authorId])
  @@map("external_resources")
}

// Polls - Admin/Moderator can create polls for users to vote on
model Poll {
  id          String   @id @default(cuid())
  question    String   // Poll question
  description String?  @db.Text // Optional description
  isActive    Boolean  @default(true) // Only active polls are shown
  isMultiple  Boolean  @default(false) // Allow multiple choices
  
  // Author
  createdById String
  createdBy   User   @relation("PollCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Optional expiration date
  
  // Relations
  options PollOption[]
  votes   PollVote[]
  
  @@index([isActive])
  @@index([createdAt])
  @@index([createdById])
  @@map("polls")
}

// Poll Options - Individual choices for a poll
model PollOption {
  id       String @id @default(cuid())
  pollId   String
  text     String // Option text
  order    Int    @default(0) // Display order
  
  // Relations
  poll  Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes PollVote[]
  
  @@index([pollId])
  @@map("poll_options")
}

// Poll Votes - Track user votes
model PollVote {
  id        String   @id @default(cuid())
  pollId    String
  optionId  String
  userId    String
  createdAt DateTime @default(now())
  
  // Relations
  poll   Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user   User       @relation("PollVoter", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([pollId, userId, optionId]) // Prevent duplicate votes for same option
  @@index([pollId])
  @@index([optionId])
  @@index([userId])
  @@map("poll_votes")
}

// Teacher - –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞
model Teacher {
  id          String   @id @default(cuid())
  fullName    String   // –§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
  department  String   // –ö–∞—Ñ–µ–¥—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ê–Ω–∞—Ç–æ–º–∏—è", "–§–∏–∑–∏–æ–ª–æ–≥–∏—è")
  position    String?  // –î–æ–ª–∂–Ω–æ—Å—Ç—å (–ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –¥–æ—Ü–µ–Ω—Ç, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)
  photoUrl    String?  // URL —Ñ–æ—Ç–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è (Supabase Storage)
  bio         String?  @db.Text // –ö—Ä–∞—Ç–∫–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è
  academicDegree String? // –£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å
  isActive    Boolean  @default(true) // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  averageRating Float   @default(0) // –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
  totalRatings  Int     @default(0) // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  ratings  TeacherRating[]
  reviews  TeacherReview[]
  subjects TeacherSubject[] // –°–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
  
  @@index([department])
  @@index([averageRating])
  @@index([isActive])
  @@map("teachers")
}

// TeacherSubject - –°–≤—è–∑—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
model TeacherSubject {
  id        String   @id @default(cuid())
  teacherId String
  subjectId String
  createdAt DateTime @default(now())
  
  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

// TeacherRating - –†–µ–π—Ç–∏–Ω–≥–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
model TeacherRating {
  id          String   @id @default(cuid())
  teacherId   String
  userId      String
  
  // –†–µ–π—Ç–∏–Ω–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (1-5 –∑–≤–µ–∑–¥)
  knowledgeRating      Int // –ó–Ω–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
  teachingRating       Int // –ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è
  communicationRating  Int // –ö–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
  fairnessRating       Int // –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–∞—Ö
  
  overallRating Float // –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (—Å—Ä–µ–¥–Ω–µ–µ)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  user    User    @relation("UserTeacherRatings", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teacherId, userId]) // –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  @@index([teacherId])
  @@index([userId])
  @@index([overallRating])
  @@map("teacher_ratings")
}

// TeacherReview - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏/–æ—Ç–∑—ã–≤—ã –æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è—Ö
model TeacherReview {
  id        String        @id @default(cuid())
  teacherId String
  userId    String
  content   String        @db.Text
  isAnonymous Boolean     @default(false) // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –æ—Ç–∑—ã–≤
  status    ContentStatus @default(PENDING) // –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤
  
  // –õ–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏ –¥–ª—è –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –æ—Ç–∑—ã–≤–∞
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  teacher    Teacher              @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  user       User                 @relation("UserTeacherReviews", fields: [userId], references: [id], onDelete: Cascade)
  helpfulness TeacherReviewHelpful[]
  
  @@index([teacherId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("teacher_reviews")
}

// TeacherReviewHelpful - –û—Ç–º–µ—Ç–∫–∏ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –æ—Ç–∑—ã–≤–æ–≤
model TeacherReviewHelpful {
  id       String  @id @default(cuid())
  reviewId String
  userId   String
  isHelpful Boolean // true = helpful, false = unhelpful
  
  createdAt DateTime @default(now())
  
  // Relations
  review TeacherReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User          @relation("UserReviewHelpful", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("teacher_review_helpful")
}
